---
title: "p8105_hw6_dcm2192"
author: "Dylan Morgan"
date: "2024-12-02"
output: github_document
---

Load packages.
```{r setup, message = FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
```

## Problem 2

Load data. 
```{r}
homicide_data <- read_csv("./data/homicide-data.csv")
```

Create city_state variable and homicide solved binary variable. 
Remove cities with missing or inaccurate data. 
Limit victim_race data to black or white, and make victim_age numeric.
```{r}
homicide_data <-
  homicide_data |>
  mutate(
    city_state = str_c(city, ", ", state), 
    solved = as.numeric(disposition == "Closed by arrest"), 
    victim_age = as.numeric(victim_age)
  ) |> 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")), 
         victim_race %in% c("White", "Black")
         )
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.

Create Baltimore dataset.
```{r}
baltimore_homicide_data <- 
  homicide_data |> 
  filter(city_state == "Baltimore, MD")
```

Fit logistic regression to Baltimore homicide data. 
Present estimate and CI of OR for solving homicides comparing male victims to female victims, with all other variables fixed. 
```{r}
baltimore_fit_log <- 
  baltimore_homicide_data |> 
  glm(solved ~ victim_age + victim_sex + victim_race, data = _, family = binomial())

baltimore_fit_log |>
  broom::tidy() |>
  mutate(OR = exp(estimate), 
         CI_lower = confint(baltimore_fit_log)[,1], 
         CI_upper = confint(baltimore_fit_log)[,2]) |>
  select(term, log_OR = estimate, OR, CI_lower, CI_upper, p.value) |>
  knitr::kable(digits = 3)
```

Run models for each city.
```{r}
nest_glm_cities_results <- 
  homicide_data |> 
  nest(data = -city_state) |> 
  mutate(
    models = map(data, \(df) glm(solved ~ victim_age + victim_sex + victim_race, data = df)), 
    results = map(models, broom::tidy)) |> 
  unnest(results)

confint(glm(solved ~ victim_age + victim_sex + victim_race, data = homicide_data))

nest_glm_cities_results |> 
  select(city_state, term, estimate) |> 
  mutate(term = fct_inorder(term)) |> 
  pivot_wider(
    names_from = term, values_from = estimate) |> 
  knitr::kable(digits = 3)
```





